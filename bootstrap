#!/usr/bin/env zsh

DOTFILES_ROOT=$(dirname "${BASH_SOURCE[0]:-$0}")

set -ue

RED=$(tput setaf 1)
GREEN=$(tput setaf 2)

success () {
  printf "${GREEN} [ OK ] $1\n"
}

# ----------------------
# Install tools
# ----------------------

install_homebrew() {
  echo "Setup Homebrew..."
  # install homebrew
  if has "brew"; then
    echo "Already installed Homebrew"
  else
    echo "Installing Homebrew..."

    if test "$(uname -m)" = "x86_64"; then
      /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/master/install.sh)"
    elif test "$(uname)" = "arm64"; then
      echo "Installing to /usr/local for using emulation with Rosseta 2 (1/2)"
      arch -x86_64 /bin/bash -c "$(curl -fsSL https://raw.githubusercontent.com/Homebrew/install/HEAD/install.sh)"

      echo "Installing to /opt/homebrew for natively running on macOS ARM (2/2)"
      cd /opt
      mkdir homebrew && curl -L https://github.com/Homebrew/brew/tarball/master | tar xz --strip 1 -C homebrew
    fi

    success 'Homebrew'
  fi
}

install_packages_via_homebrew() {
  echo "Installing packages via Homebrew..."
  $DOTFILES_ROOT/brew/brew.sh
  wait

  success 'Packages Installation by Homebrew'
}

setup_anyenv() {
  echo "Setup anyenv..."

  if hash anyenv 2>/dev/null; then
    echo "`anyenv` is already installed."
  else
    echo "Install anyenv..."
    brew install anyenv

    exec $SHELL -l

    echo "Initialize anyenv"
    anyenv init

    mkdir -p $(anyenv root)/plugins
    git clone "https://github.com/znz/anyenv-update.git" "$(anyenv root)/plugins/anyenv-update"
  fi

  anyenv update
  anyenv install nodenv
  anyenv install rbenv

  success 'Setup anyenv'
}

set_default_shell() {
  if [[ "$SHELL" != "/usr/local/bin/zsh" ]]; then
    sudo bash -c 'echo "/usr/local/bin/zsh" >> /etc/shells'
    chsh -s /usr/local/bin/zsh
  fi
}

# ----------------------
# Set symlinks
# ----------------------

create_symlinks() {
  echo "Create symlinks..."

  for file in .??*
  do
    [ "$file" = ".git" ] && continue
    [ "$file" = ".vimrc.*" ] && continue
    ln -snfv "$DOTFILES_ROOT/$file" "$HOME/$file"
  done

  success 'Done symlinks'
}

# ----------------------
# zsh
# ----------------------

install_zsh_tools() {
  /bin/zsh $DOTFILES_ROOT/scripts/install-prezto.zsh
}

if [ $1 -eq "all" ] || [ -z $1 ]; then
  install_homebrew
  install_packages_via_homebrew
  install_zsh_tools

  set_default_shell
  setup_anyenv

  create_symlinks
fi
